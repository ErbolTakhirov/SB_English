{% extends 'teen/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row g-4">
        <!-- AI Advisor Sidebar -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-lg rounded-4 bg-dark text-white overflow-hidden mb-4">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="flex-shrink-0">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center"
                                style="width: 50px; height: 50px;">
                                <i class="fas fa-robot fs-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-0">Твой AI Советник</h5>
                            <span class="badge bg-success small">Online</span>
                        </div>
                    </div>

                    <div id="aiAdviceContainer" class="advice-content p-3 rounded-3"
                        style="background: rgba(255,255,255,0.1); border-left: 4px solid #10b981; min-height: 150px;">
                        <span class="spinner-border spinner-border-sm text-light me-2" role="status"></span>
                        <span class="small text-white-50">Генерирую совет...</span>
                    </div>

                    <button class="btn btn-outline-light w-100 rounded-pill mt-4" onclick="loadAdvice()">Обновить
                        анализ</button>
                    <a href="{% url 'core:ai_coach' %}" class="btn btn-primary w-100 rounded-pill mt-2">Спросить
                        подробнее</a>
                </div>
            </div>

            <!-- Forecast Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-4">Твой прогноз <span class="badge bg-light text-dark float-end small"
                            id="forecastConf">--%</span></h5>

                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <small class="text-muted d-block">Доход</small>
                            <div class="fw-bold text-success fs-5" id="fsIncome">--</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">Расход</small>
                            <div class="fw-bold text-primary fs-5" id="fsExpense">--</div>
                        </div>
                    </div>

                    <div class="p-3 bg-light rounded-3 text-center">
                        <div class="display-6 fw-bold text-primary mb-1" id="fsNet">--</div>
                        <p class="text-muted small mb-0">Ожидаемый остаток</p>
                    </div>

                    <hr>
                    <p class="small text-muted mb-0"><i class="fas fa-info-circle me-1"></i> Прогноз основан на твоей
                        активности за последние 6 месяцев.</p>
                </div>
            </div>
        </div>

        <!-- Main Analytics Area -->
        <div class="col-lg-8">
            <!-- Spending Chart -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white border-0 p-4">
                    <h5 class="mb-0">Куда уходят деньги?</h5>
                </div>
                <div class="card-body p-4 pt-0">
                    <div style="height: 300px;">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Money Leaks -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-header bg-white border-0 p-4 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-danger"><i class="fas fa-search-dollar me-2"></i>Утечки бюджета</h5>
                </div>
                <div class="card-body p-4 pt-0" id="leaksContainer">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadForecastAndLeaks();
        loadSpendingAnalysis();
        loadAdvice();
    });

    async function loadForecastAndLeaks() {
        try {
            const response = await fetch('/api/forecast/');
            const data = await response.json();

            // Update Forecast
            const f = data.forecast;
            document.getElementById('fsIncome').textContent = Math.round(f.predicted_income).toLocaleString();
            document.getElementById('fsExpense').textContent = Math.round(f.predicted_expense).toLocaleString();
            document.getElementById('forecastConf').textContent = Math.round(f.confidence * 100) + '%';
            document.getElementById('fsNet').textContent = Math.round(f.predicted_income - f.predicted_expense).toLocaleString();

            // Render Leaks
            const container = document.getElementById('leaksContainer');
            container.innerHTML = '';

            if (data.money_leaks && data.money_leaks.length > 0) {
                data.money_leaks.forEach(leak => {
                    const percentage = Math.round(leak.percentage);
                    const html = `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fw-bold">${leak.category}</span>
                            <span class="text-danger fw-bold">-${Math.round(leak.amount).toLocaleString()} сом</span>
                        </div>
                        <div class="progress rounded-pill bg-light" style="height: 10px;">
                            <div class="progress-bar bg-danger" role="progressbar" style="width: ${percentage}%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted"><i class="fas fa-chart-line me-1"></i>${leak.trend}</small>
                            <small class="text-muted">${percentage}% от всех расходов</small>
                        </div>
                    </div>
                `;
                    container.innerHTML += html;
                });
            } else {
                container.innerHTML = `
                <div class="text-center py-4 text-success">
                    <i class="fas fa-check-circle fa-3x mb-3 opacity-50"></i>
                    <p>Отлично! Явных утечек бюджета не найдено.</p>
                </div>
            `;
            }
        } catch (e) {
            console.error("Forecast error:", e);
        }
    }

    async function loadSpendingAnalysis() {
        try {
            const response = await fetch('/api/spending/analysis/');
            const data = await response.json();

            const ctx = document.getElementById('spendingChart').getContext('2d');

            if (!data.categories || data.categories.length === 0) {
                // Show empty state
                return;
            }

            const labels = data.categories.map(c => c.category);
            const amounts = data.categories.map(c => c.total);
            const colors = [
                '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
                '#f59e0b', '#10b981', '#3b82f6', '#64748b'
            ];

            new Chart(ctx, {
                type: 'doughnut', // Pie charts are great for parts-of-whole
                data: {
                    labels: labels,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors,
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { family: 'Overpass, sans-serif' }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });

        } catch (e) {
            console.error("Chart error:", e);
        }
    }

    async function loadAdvice() {
        const container = document.getElementById('aiAdviceContainer');
        container.innerHTML = `
        <div class="d-flex align-items-center text-white-50">
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>Анализирую финансы...</span>
        </div>
    `;

        try {
            const response = await fetch('/api/advice/monthly/');
            const data = await response.json();

            // Convert newlines to breaks and styling
            const adviceHtml = data.summary.replace(/\n/g, '<br>');

            container.innerHTML = `
            <div class="small fw-bold mb-2 text-uppercase opacity-75 text-white">Персональный совет:</div>
            <p class="mb-2" style="font-size: 0.95rem;">${adviceHtml}</p>
        `;

            if (data.action_items && data.action_items.length > 0) {
                let actionsHtml = '<ul class="mb-0 ps-3 small text-white-50 mt-2">';
                data.action_items.slice(0, 3).forEach(item => {
                    actionsHtml += `<li>${item}</li>`;
                });
                actionsHtml += '</ul>';
                container.innerHTML += actionsHtml;
            }

        } catch (e) {
            container.innerHTML = `<span class="text-danger small">Ошибка получения совета</span>`;
            console.error(e);
        }
    }
</script>
{% endblock %}