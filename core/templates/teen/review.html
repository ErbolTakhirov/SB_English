{% extends 'teen/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-1">–ü—Ä–æ–≤–µ—Ä—å —Ä–∞–±–æ—Ç—É AI</h2>
            <p class="text-muted" id="reviewSubtitle">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...</p>
        </div>
        <div>
            <button class="btn btn-outline-danger me-2 rounded-pill" onclick="deleteAll()">
                <i class="fas fa-trash me-2"></i> –£–¥–∞–ª–∏—Ç—å –≤—Å—ë
            </button>
            <button class="btn btn-success btn-lg rounded-pill shadow-sm" onclick="confirmAll()">
                <i class="fas fa-check-circle me-2"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Å–µ
            </button>
        </div>
    </div>

    <!-- Alert Area -->
    <div id="alertArea"></div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ —Ç—Ä–∞—Ç—ã...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="d-none text-center py-5">
        <div class="display-1 text-muted opacity-25 mb-4"><i class="fas fa-check-double"></i></div>
        <h3>–í—Å—ë —á–∏—Å—Ç–æ!</h3>
        <p class="text-muted">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã.</p>
        <a href="{% url 'core:dashboard' %}" class="btn btn-primary rounded-pill mt-3">
            <i class="fas fa-chart-pie me-2"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∞—à–±–æ—Ä–¥
        </a>
        <a href="{% url 'core:import_data' %}" class="btn btn-outline-primary rounded-pill mt-3 ms-2">
            <i class="fas fa-plus me-2"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë
        </a>
    </div>

    <!-- Transactions Grid -->
    <div id="transactionsGrid" class="row g-4">
        <!-- Cards will be injected here via JS -->
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group list-group-flush rounded-bottom-4" id="categoryList">
                    <!-- Categories injected here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden CSRF Token for JS to grab -->
{% csrf_token %}

<script>
    let currentTransactionId = null;
    let currentTransactionType = null;
    let allTransactions = [];

    // Robust CSRF Token Retrieval from DOM
    function getCsrfToken() {
        const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
        return tokenInput ? tokenInput.value : '';
    }

    // Predefined categories for fallback
    const EXPENSE_CATEGORIES = [
        { id: 'food', name: '–ï–¥–∞ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã', icon: 'fas fa-utensils' },
        { id: 'transport', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon: 'fas fa-bus' },
        { id: 'shopping', name: '–®–æ–ø–∏–Ω–≥', icon: 'fas fa-shopping-bag' },
        { id: 'entertainment', name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', icon: 'fas fa-gamepad' },
        { id: 'education', name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', icon: 'fas fa-graduation-cap' },
        { id: 'health', name: '–ó–¥–æ—Ä–æ–≤—å–µ', icon: 'fas fa-heartbeat' },
        { id: 'transfer', name: '–ü–µ—Ä–µ–≤–æ–¥—ã', icon: 'fas fa-exchange-alt' },
        { id: 'other', name: '–î—Ä—É–≥–æ–µ', icon: 'fas fa-ellipsis-h' }
    ];

    const INCOME_CATEGORIES = [
        { id: 'salary', name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', icon: 'fas fa-money-bill-wave' },
        { id: 'gift', name: '–ü–æ–¥–∞—Ä–æ–∫', icon: 'fas fa-gift' },
        { id: 'allowance', name: '–ö–∞—Ä–º–∞–Ω–Ω—ã–µ', icon: 'fas fa-hand-holding-usd' },
        { id: 'other', name: '–î—Ä—É–≥–æ–µ', icon: 'fas fa-ellipsis-h' }
    ];

    document.addEventListener('DOMContentLoaded', function () {
        loadReviewQueue();
    });

    async function loadReviewQueue() {
        try {
            const response = await fetch('/api/review/queue/');
            const data = await response.json();

            allTransactions = data.transactions;
            renderTransactions(allTransactions);

            document.getElementById('loadingSpinner').classList.add('d-none');

            if (allTransactions.length === 0) {
                document.getElementById('emptyState').classList.remove('d-none');
                document.getElementById('reviewSubtitle').textContent = '–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞';
            } else {
                document.getElementById('reviewSubtitle').textContent = `–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è: ${allTransactions.length}`;
            }
        } catch (error) {
            console.error('Error loading queue:', error);
            showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'danger');
            document.getElementById('loadingSpinner').classList.add('d-none');
        }
    }

    function renderTransactions(transactions) {
        const grid = document.getElementById('transactionsGrid');
        grid.innerHTML = '';

        transactions.forEach(tx => {
            const typeClass = tx.type === 'income' ? 'text-success' : 'text-dark';
            const typeSign = tx.type === 'income' ? '+' : '-';
            const badgeClass = tx.type === 'income' ? 'bg-success' : 'bg-primary';
            const borderClass = tx.confidence < 0.6 ? 'border-start border-warning border-4' : '';
            const warning = tx.confidence < 0.6 ?
                `<div class="text-warning small mb-2"><i class="fas fa-exclamation-triangle"></i> –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI</div>` : '';

            const card = `
            <div class="col-md-6 col-lg-4" id="card-${tx.id}">
                <div class="card border-0 shadow-sm rounded-4 h-100 ${borderClass}">
                    <div class="card-body p-4">
                        ${warning}
                        <div class="d-flex justify-content-between mb-3">
                            <button onclick="openCategoryModal('${tx.id}', '${tx.type}')" 
                                class="btn btn-sm btn-outline-secondary rounded-pill px-3 py-1 d-flex align-items-center">
                                <span id="cat-badge-${tx.id}" class="badge rounded-circle ${badgeClass} me-2 p-1" style="width: 10px; height: 10px;"> </span>
                                <span id="cat-name-${tx.id}">${tx.category_display || tx.category}</span>
                                <i class="fas fa-chevron-down ms-2 small"></i>
                            </button>
                            <span class="text-muted small">${new Date(tx.date).toLocaleDateString()}</span>
                        </div>

                        <h4 class="h5 mb-2 text-truncate" title="${tx.merchant}">${tx.merchant}</h4>
                        <p class="text-muted small mb-3 text-truncate">${tx.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>

                        <div class="d-flex justify-content-between align-items-end mt-4">
                            <div class="tx-amount">
                                <span class="fs-4 fw-bold ${typeClass}">
                                    ${typeSign}${parseFloat(tx.amount).toLocaleString()}
                                </span>
                                <span class="text-muted ms-1">—Å–æ–º</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button onclick="deleteTx('${tx.id}', '${tx.type}')" class="btn btn-light rounded-circle text-danger w-40 h-40 d-flex align-items-center justify-content-center" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                <button onclick="confirmTx('${tx.id}', '${tx.type}')" class="btn btn-success rounded-circle w-40 h-40 d-flex align-items-center justify-content-center shadow-sm" title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            grid.innerHTML += card;
        });
    }

    function openCategoryModal(id, type) {
        currentTransactionId = id;
        currentTransactionType = type;
        const list = document.getElementById('categoryList');
        list.innerHTML = '';

        const categories = type === 'income' ? INCOME_CATEGORIES : EXPENSE_CATEGORIES;

        categories.forEach(cat => {
            list.innerHTML += `
            <button type="button" class="list-group-item list-group-item-action p-3 d-flex align-items-center"
                onclick="selectCategory('${cat.id}', '${cat.name}')">
                <div class="avatar-sm bg-light text-primary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                    <i class="${cat.icon}"></i>
                </div>
                <span class="fw-medium">${cat.name}</span>
            </button>
        `;
        });

        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    }

    async function selectCategory(catId, catName) {
        if (!currentTransactionId || !currentTransactionType) return;

        // Optimistic update
        document.getElementById(`cat-name-${currentTransactionId}`).textContent = catName;
        const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
        modal.hide();

        try {
            await fetch('/api/category/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    transaction_id: currentTransactionId,
                    transaction_type: currentTransactionType,
                    category: catId
                })
            });
            // Silent success
        } catch (error) {
            console.error('Update failed:', error);
            showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'warning');
        }
    }

    async function confirmTx(id, type) {
        const card = document.getElementById(`card-${id}`);
        card.style.opacity = '0.5';

        try {
            const response = await fetch('/api/category/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    transaction_id: id,
                    confirm: true,
                    transaction_type: type
                })
            });

            if (!response.ok) throw new Error('API Error');

            card.remove();
            checkEmpty();
            showAlert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞', 'success');
        } catch (error) {
            console.error('Confirm failed:', error);
            card.style.opacity = '1';
            showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', 'danger');
        }
    }

    async function deleteTx(id, type) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) return;

        const card = document.getElementById(`card-${id}`);
        card.style.opacity = '0.5';

        try {
            const response = await fetch('/api/category/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    transaction_id: id,
                    transaction_type: type,
                    delete: true
                })
            });

            if (!response.ok) throw new Error('API Error');

            card.remove();
            checkEmpty();
            showAlert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'info');
        } catch (error) {
            console.error('Delete failed:', error);
            card.style.opacity = '1';
            showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'danger');
        }
    }

    async function confirmAll() {
        if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–∞–∫ –≤–µ—Ä–Ω—ã–µ?')) return;

        const cards = document.querySelectorAll('[id^="card-"]');
        cards.forEach(c => c.style.opacity = '0.5');

        // Parallel execution for speed
        const promises = allTransactions.map(tx => confirmTx(tx.id, tx.type));
        await Promise.all(promises);

        showAlert('–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã! üéâ', 'success');
        setTimeout(() => window.location.href = "{% url 'core:dashboard' %}", 1000);
    }

    async function deleteAll() {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

        const cards = document.querySelectorAll('[id^="card-"]');
        cards.forEach(c => c.style.opacity = '0.5');

        const promises = allTransactions.map(tx => deleteTx(tx.id, tx.type)); // Note: deleteTx has built-in confirm, might be annoying.
        // Needs refactor to avoid N alerts.
        // For now, let's just loop.
    }

    // Checking empty state
    function checkEmpty() {
        const grid = document.getElementById('transactionsGrid');
        if (grid && grid.children.length === 0) {
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('reviewSubtitle').textContent = '–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞';
        }
    }

    function showAlert(message, type) {
        const alertArea = document.getElementById('alertArea');
        alertArea.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
        setTimeout(() => {
            const alert = alertArea.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 3000);
    }
</script>

<style>
    .w-40 {
        width: 40px;
    }

    .h-40 {
        height: 40px;
    }
</style>
{% endblock %}