{% extends 'teen/base.html' %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - SB Finance AI{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="teen-card p-4">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="h2 mb-2">
                        {% if user.teen_profile.demo_mode %}
                        <span class="badge bg-warning me-3">–î–ï–ú–û</span>
                        {% endif %}
                        –ü—Ä–∏–≤–µ—Ç, {{ user.username }}! üëã
                    </h1>
                    <p class="text-muted mb-0">
                        {% if user.teen_profile.demo_mode %}
                        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–µ–º–æ! –ò—Å—Å–ª–µ–¥—É–π—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ SB Finance AI –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–≤.
                        {% else %}
                        –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤—ã–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º? –î–∞–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ –Ω–∞—É—á–∏–º—Å—è —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–µ–Ω—å–≥–∞–º–∏!
                        {% endif %}
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <div class="d-flex justify-content-lg-end gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tourModal">
                            <i class="bi bi-play-circle me-2"></i>–¢—É—Ä –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
                        </button>
                        {% if not user.teen_profile.demo_mode %}
                        <button class="btn btn-outline-primary" data-bs-toggle="modal"
                            data-bs-target="#onboardingModal">
                            <i class="bi bi-lightning me-2"></i>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Financial IQ & Stats Row -->
<div class="row mb-4">
    <!-- Financial IQ Score -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ gamification.financial_iq_score|default:0 }}</div>
            <div class="stat-label">
                <i class="bi bi-brain me-1"></i>Financial IQ
            </div>
            <div class="progress mt-3">
                <div class="progress-bar" style="width: {{ gamification.financial_iq_score|default:0 }}%"></div>
            </div>
        </div>
    </div>

    <!-- Current Streak -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ gamification.current_streak|default:0 }}</div>
            <div class="stat-label">
                <i class="bi bi-fire me-1"></i>–î–Ω–µ–π –ø–æ–¥—Ä—è–¥
            </div>
            {% if gamification.current_streak and gamification.current_streak > 0 %}
            <small class="text-success">
                <i class="bi bi-arrow-up"></i> –õ—É—á—à–∏–π: {{ gamification.longest_streak|default:0 }}
            </small>
            {% else %}
            <small class="text-muted">–ù–∞—á–Ω–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º!</small>
            {% endif %}
        </div>
    </div>

    <!-- Total Achievements -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ gamification.total_achievements|default:0 }}</div>
            <div class="stat-label">
                <i class="bi bi-trophy me-1"></i>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </div>
            {% if gamification.total_achievements and gamification.total_achievements > 0 %}
            <small class="text-primary">
                <i class="bi bi-star"></i> –£—Ä–æ–≤–µ–Ω—å {{ gamification.level|default:1 }}
            </small>
            {% else %}
            <small class="text-muted">–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!</small>
            {% endif %}
        </div>
    </div>

    <!-- Total Points -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card">
            <div class="stat-number">{{ gamification.total_points|default:0 }}</div>
            <div class="stat-label">
                <i class="bi bi-lightning me-1"></i>–û—á–∫–∏
            </div>
            {% if gamification.progress_to_next_level %}
            <small class="text-warning">
                –î–æ —É—Ä–æ–≤–Ω—è {{ gamification.level|add:1 }}: {{ gamification.progress_to_next_level.needed }} –æ—á–∫–æ–≤
            </small>
            {% else %}
            <small class="text-muted">–ó–∞–≤–µ—Ä—à–∞–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è!</small>
            {% endif %}
        </div>
    </div>
</div>

<!-- Main Content Row -->
<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- AI Accountant Banner -->
        <div class="card border-0 shadow-sm rounded-4 mb-4 bg-gradient overflow-hidden"
            style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white;">
            <div class="card-body p-4 position-relative">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="h4 mb-2">–£–º–Ω—ã–π AI-–ë—É—Ö–≥–∞–ª—Ç–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! üöÄ</h3>
                        <p class="mb-3 opacity-90">–ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç —Ç—Ä–∞—Ç, –∞ AI —Å–∞–º –∏—Ö —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç –∏ –¥–∞—Å—Ç —Å–æ–≤–µ—Ç—ã.</p>
                        <div class="d-flex gap-2">
                            <a href="{% url 'core:import_data' %}" class="btn btn-light rounded-pill px-4 fw-bold">–£–º–Ω—ã–π
                                –∏–º–ø–æ—Ä—Ç</a>
                            <a href="{% url 'core:ai_insights' %}"
                                class="btn btn-outline-light rounded-pill px-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
                        </div>
                    </div>
                </div>
                <div class="position-absolute end-0 top-0 opacity-25 p-3 d-none d-md-block">
                    <i class="bi bi-robot" style="font-size: 8rem;"></i>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="teen-card p-4 mb-4">
            <h3 class="h5 mb-3">
                <i class="bi bi-lightning me-2"></i>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            </h3>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <a href="{% url 'core:expense_create' %}" class="btn btn-outline-primary w-100 py-3">
                        <i class="bi bi-receipt d-block mb-2" style="font-size: 1.5rem;"></i>
                        –†–∞—Å—Ö–æ–¥
                    </a>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="{% url 'core:income_create' %}" class="btn btn-outline-primary w-100 py-3">
                        <i class="bi bi-plus-circle d-block mb-2" style="font-size: 1.5rem;"></i>
                        –î–æ—Ö–æ–¥
                    </a>
                </div>
                <div class="col-md-4 mb-3">
                    <a href="{% url 'core:import_data' %}" class="btn btn-primary w-100 py-3 shadow-sm">
                        <i class="bi bi-magic d-block mb-2" style="font-size: 1.5rem;"></i>
                        –£–º–Ω—ã–π –ò–º–ø–æ—Ä—Ç
                    </a>
                </div>
            </div>
        </div>

        <!-- Active Goals -->
        <div class="teen-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="h5 mb-0">
                    <i class="bi bi-bullseye me-2"></i>–ú–æ–∏ —Ü–µ–ª–∏
                </h3>
                <a href="{% url 'core:goals' %}" class="btn btn-sm btn-primary">
                    –í—Å–µ —Ü–µ–ª–∏
                </a>
            </div>

            {% if recent_goals %}
            {% for goal in recent_goals %}
            <div class="goal-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">{{ goal.title }}</h6>
                    <span class="goal-progress">{{ goal.progress_percentage|floatformat:0 }}%</span>
                </div>
                <p class="text-muted small mb-2">{{ goal.description|default:"–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è" }}</p>
                <div class="row align-items-center">
                    <div class="col-sm-8">
                        <div class="progress mb-2">
                            <div class="progress-bar" style="width: {{ goal.progress_percentage }}%"></div>
                        </div>
                        <small class="text-muted">
                            {{ goal.current_amount|floatformat:0 }} / {{ goal.target_amount|floatformat:0 }} —Å–æ–º
                            {% if goal.days_remaining > 0 %}
                            ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å {{ goal.days_remaining }} –¥–Ω–µ–π
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-sm-4 text-sm-end">
                        <form method="post" action="{% url 'core:update_goal_progress' goal.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal"
                                data-bs-target="#updateGoalModal{{ goal.id }}">
                                <i class="bi bi-plus-circle me-1"></i>–î–æ–±–∞–≤–∏—Ç—å
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-bullseye" style="font-size: 3rem; color: #d1d5db;"></i>
                <h6 class="mt-3 text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</h6>
                <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ü–µ–ª—å –∏ –Ω–∞—á–Ω–∏—Ç–µ –∫–æ–ø–∏—Ç—å!</p>
                <a href="{% url 'core:goals' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å
                </a>
            </div>
            {% endif %}
        </div>

        <!-- AI Coach Preview -->
        <div class="teen-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="h5 mb-0">
                    <i class="bi bi-robot me-2"></i>AI –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–æ—É—á
                </h3>
                <a href="{% url 'core:ai_coach' %}" class="btn btn-sm btn-primary">
                    –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
                </a>
            </div>

            {% if recent_chats %}
            <div class="chat-container" style="height: 200px;">
                {% for session in recent_chats %}
                {% for message in session.teen_messages|slice:":2" %}
                <div class="chat-message {{ message.role }}">
                    <div class="chat-bubble {{ message.role }}">
                        {{ message.content|truncatechars:100 }}
                    </div>
                </div>
                {% endfor %}
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="bi bi-chat-dots" style="font-size: 3rem; color: #d1d5db;"></i>
                <h6 class="mt-3 text-muted">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å AI</h6>
                <p class="text-muted">–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ –¥–µ–Ω—å–≥–∞—Ö, –±—é–¥–∂–µ—Ç–µ –∏–ª–∏ —Ü–µ–ª—è—Ö</p>
                <a href="{% url 'core:ai_coach' %}" class="btn btn-primary">
                    <i class="bi bi-chat-dots me-2"></i>–ù–∞—á–∞—Ç—å —á–∞—Ç
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- AI Financial Forecast -->
        <div class="teen-card p-4 mb-4">
            <h3 class="h6 mb-3 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up-arrow me-2 text-purple"></i>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –º–µ—Å—è—Ü</span>
                <span class="badge bg-purple-soft text-purple rounded-pill small" id="forecastConfidence">--%</span>
            </h3>
            <div class="row text-center mb-3">
                <div class="col-6 border-end">
                    <small class="text-muted d-block mb-1">–î–æ—Ö–æ–¥</small>
                    <div class="fw-bold text-success" id="forecastIncome">--</div>
                </div>
                <div class="col-6">
                    <small class="text-muted d-block mb-1">–†–∞—Å—Ö–æ–¥</small>
                    <div class="fw-bold text-primary" id="forecastExpense">--</div>
                </div>
            </div>
            <div class="p-3 bg-light rounded-3">
                <div class="d-flex justify-content-between mb-1">
                    <span class="small text-muted">–û–∂–∏–¥–∞–µ–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫:</span>
                    <span class="small fw-bold text-dark" id="forecastNet">--</span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="forecastBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Money Leaks Widget -->
        <div class="teen-card p-4 mb-4">
            <h3 class="h6 mb-3">
                <i class="bi bi-droplet-half me-2 text-danger"></i>–£—Ç–µ—á–∫–∏ –¥–µ–Ω–µ–≥
            </h3>
            <div id="moneyLeaksList">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-muted" role="status"></div>
                </div>
            </div>
            <div class="mt-3 text-center">
                <a href="{% url 'core:ai_insights' %}" class="btn btn-sm btn-outline-danger rounded-pill">
                    –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?
                </a>
            </div>
        </div>


        <!-- Recent Insights -->
        <div class="teen-card p-4 mb-4">
            <h3 class="h6 mb-3">
                <i class="bi bi-lightbulb me-2"></i>AI –ò–Ω—Å–∞–π—Ç—ã
            </h3>

            {% if recent_insights %}
            {% for insight in recent_insights %}
            <div class="border-start border-primary border-3 ps-3 mb-3">
                <h6 class="mb-1">{{ insight.title }}</h6>
                <p class="text-muted small mb-2">{{ insight.content|truncatechars:80 }}</p>
                <small class="text-muted">{{ insight.created_at|date:"d.m H:i" }}</small>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-3">
                <i class="bi bi-lightbulb" style="font-size: 2rem; color: #d1d5db;"></i>
                <p class="text-muted small mt-2">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤</p>
            </div>
            {% endif %}
        </div>

        <!-- Next Achievements -->
        <div class="teen-card p-4 mb-4">
            <h3 class="h6 mb-3">
                <i class="bi bi-star me-2"></i>–°–ª–µ–¥—É—é—â–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </h3>

            {% if gamification.next_achievements %}
            {% for next_achievement in gamification.next_achievements %}
            <div class="d-flex align-items-center mb-3">
                <div class="achievement-icon me-3">{{ next_achievement.icon }}</div>
                <div class="flex-grow-1">
                    <h6 class="mb-1 small">{{ next_achievement.title }}</h6>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" style="width: {{ next_achievement.progress }}%"></div>
                    </div>
                    <small class="text-muted">{{ next_achievement.progress }}% –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-3">
                <i class="bi bi-trophy" style="font-size: 2rem; color: #d1d5db;"></i>
                <p class="text-muted small mt-2">–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!</p>
            </div>
            {% endif %}
        </div>

        <!-- Learning Modules -->
        <div class="teen-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="h6 mb-0">
                    <i class="bi bi-book me-2"></i>–£—Ä–æ–∫–∏
                </h3>
                <a href="{% url 'core:learning' %}" class="btn btn-sm btn-primary">–í—Å–µ</a>
            </div>

            {% if learning_modules %}
            {% for module in learning_modules %}
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-bookmark me-2 text-primary"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-1 small">{{ module.title }}</h6>
                    <small class="text-muted">{{ module.estimated_time }} –º–∏–Ω</small>
                </div>
                <span
                    class="badge bg-{% if module.difficulty == 'beginner' %}success{% elif module.difficulty == 'intermediate' %}warning{% else %}danger{% endif %} small">
                    {{ module.get_difficulty_display }}
                </span>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-3">
                <i class="bi bi-book" style="font-size: 2rem; color: #d1d5db;"></i>
                <p class="text-muted small mt-2">–£—Ä–æ–∫–∏ —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Update Goal Progress Modals -->
{% for goal in recent_goals %}
<div class="modal fade" id="updateGoalModal{{ goal.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content teen-card">
            <div class="modal-header border-0">
                <h5 class="modal-title">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: {{ goal.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'core:update_goal_progress' goal.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</label>
                        <input type="number" class="form-control" name="current_amount"
                            value="{{ goal.current_amount|floatformat:0 }}" step="0.01" min="0">
                        <div class="form-text">
                            –°–µ–π—á–∞—Å –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: {{ goal.current_amount|floatformat:0 }} —Å–æ–º
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>–û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- App Tour Modal -->
<div class="modal fade" id="tourModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content teen-card">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-play-circle me-2"></i>–¢—É—Ä –ø–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="tourCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="0"
                            class="active"></button>
                        <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="3"></button>
                    </div>
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <div class="text-center p-4">
                                <i class="bi bi-robot" style="font-size: 4rem; color: var(--primary-color);"></i>
                                <h4 class="mt-3">AI –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ö–æ—É—á</h4>
                                <p>–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–µ–Ω—å–≥–∞—Ö, –±—é–¥–∂–µ—Ç–µ –∏ —Ü–µ–ª—è—Ö. AI –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ–º–∞—Ö
                                    –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º!</p>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="text-center p-4">
                                <i class="bi bi-bullseye" style="font-size: 4rem; color: var(--primary-color);"></i>
                                <h4 class="mt-3">–¶–µ–ª–∏ –∏ –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</h4>
                                <p>–°—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å–æ–≤–µ—Ç—ã –æ—Ç AI, –∫–∞–∫ –Ω–∞–∫–æ–ø–∏—Ç—å –Ω—É–∂–Ω—É—é
                                    —Å—É–º–º—É –∫ –Ω—É–∂–Ω–æ–π –¥–∞—Ç–µ.</p>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="text-center p-4">
                                <i class="bi bi-trophy" style="font-size: 4rem; color: var(--primary-color);"></i>
                                <h4 class="mt-3">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ò–≥—Ä–æ—Ñ–∏–∫–∞—Ü–∏—è</h4>
                                <p>–ü–æ–ª—É—á–∞–π—Ç–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∑–∞ –æ–±—É—á–µ–Ω–∏–µ, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–µ–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–Ω—å–≥–∞–º–∏!
                                </p>
                            </div>
                        </div>
                        <div class="carousel-item">
                            <div class="text-center p-4">
                                <i class="bi bi-shield-check" style="font-size: 4rem; color: var(--primary-color);"></i>
                                <h4 class="mt-3">–ó–∞—â–∏—Ç–∞ –æ—Ç –ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞</h4>
                                <p>–£–∑–Ω–∞–≤–∞–π—Ç–µ, –∫–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –∑–∞—â–∏—Ç–∏—Ç—å —Å–≤–æ–∏ –¥–µ–Ω—å–≥–∏ –æ—Ç
                                    –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <a href="{% url 'core:ai_coach' %}" class="btn btn-primary">
                    <i class="bi bi-chat-dots me-2"></i>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å AI
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Onboarding Modal -->
<div class="modal fade" id="onboardingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content teen-card">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-lightning me-2"></i>–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center p-4">
                            <i class="bi bi-plus-circle" style="font-size: 3rem; color: var(--success-color);"></i>
                            <h5 class="mt-3">1. –î–æ–±–∞–≤—å—Ç–µ –¥–æ—Ö–æ–¥—ã</h5>
                            <p class="text-muted">–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞, –ø–æ–¥–∞—Ä–∫–∏</p>
                            <a href="{% url 'core:income_create' %}" class="btn btn-success">
                                <i class="bi bi-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center p-4">
                            <i class="bi bi-receipt" style="font-size: 3rem; color: var(--warning-color);"></i>
                            <h5 class="mt-3">2. –ó–∞–ø–∏—à–∏—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã</h5>
                            <p class="text-muted">–ï–¥–∞, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ø–æ–∫—É–ø–∫–∏</p>
                            <a href="{% url 'core:expense_create' %}" class="btn btn-warning">
                                <i class="bi bi-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center p-4">
                            <i class="bi bi-bullseye" style="font-size: 3rem; color: var(--primary-color);"></i>
                            <h5 class="mt-3">3. –ü–æ—Å—Ç–∞–≤—å—Ç–µ —Ü–µ–ª—å</h5>
                            <p class="text-muted">–ù–∞ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–∫–æ–ø–∏—Ç—å?</p>
                            <a href="{% url 'core:goals' %}" class="btn btn-primary">
                                <i class="bi bi-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center p-4">
                            <i class="bi bi-chat-dots" style="font-size: 3rem; color: var(--secondary-color);"></i>
                            <h5 class="mt-3">4. –°–ø—Ä–æ—Å–∏—Ç–µ AI</h5>
                            <p class="text-muted">–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</p>
                            <a href="{% url 'core:ai_coach' %}" class="btn btn-secondary">
                                <i class="bi bi-chat me-2"></i>–ù–∞—á–∞—Ç—å —á–∞—Ç
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Load AI Forecast & Leaks
        loadAIForecast();

        // Add confetti effect for achievements
        {% if achievements_unlocked and achievements_unlocked > 0 %}
        setTimeout(function () {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b']
            });
        }, 1500);
        {% endif %}

        // Auto-refresh stats every 30 seconds
        setInterval(function () {
            fetch('/teen/api/refresh-stats/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update Financial IQ
                        const iqElement = document.querySelector('.stat-card .stat-number');
                        if (iqElement && data.financial_iq !== undefined) {
                            iqElement.textContent = data.financial_iq;
                        }
                    }
                })
                .catch(error => console.log('Stats refresh failed:', error));
        }, 30000);
    });

    async function loadAIForecast() {
        try {
            const response = await fetch('/api/forecast/');
            const data = await response.json();

            // Update Forecast Widget
            const forecast = data.forecast;
            document.getElementById('forecastIncome').textContent = Math.round(forecast.predicted_income).toLocaleString();
            document.getElementById('forecastExpense').textContent = Math.round(forecast.predicted_expense).toLocaleString();
            document.getElementById('forecastConfidence').textContent = Math.round(forecast.confidence * 100) + '%';

            const net = forecast.predicted_income - forecast.predicted_expense;
            const netEl = document.getElementById('forecastNet');
            const barEl = document.getElementById('forecastBar');

            netEl.textContent = Math.round(net).toLocaleString() + ' —Å–æ–º';
            if (net >= 0) {
                netEl.className = 'small fw-bold text-success';
                const percent = Math.min(100, (net / forecast.predicted_income) * 100);
                barEl.style.width = percent + '%';
                barEl.className = 'progress-bar bg-success';
            } else {
                netEl.className = 'small fw-bold text-danger';
                barEl.style.width = '100%';
                barEl.className = 'progress-bar bg-danger';
            }

            // Update Money Leaks
            const leaksList = document.getElementById('moneyLeaksList');
            leaksList.innerHTML = '';

            if (data.money_leaks && data.money_leaks.length > 0) {
                data.money_leaks.forEach(leak => {
                    const el = document.createElement('div');
                    el.className = 'd-flex justify-content-between align-items-center mb-2 pb-2 border-bottom';
                    el.innerHTML = `
                        <div>
                            <span class="fw-medium small d-block">${leak.category}</span>
                            <span class="text-xs text-muted">${leak.trend}</span>
                        </div>
                        <div class="text-end">
                            <span class="fw-bold text-danger small">-${Math.round(leak.amount).toLocaleString()}</span>
                            <span class="d-block text-xs text-muted">${Math.round(leak.percentage)}% –æ—Ç –≤—Å–µ—Ö —Ç—Ä–∞—Ç</span>
                        </div>
                    `;
                    leaksList.appendChild(el);
                });
            } else {
                leaksList.innerHTML = `
                    <div class="text-center py-3">
                        <i class="bi bi-check-circle text-success mb-2" style="font-size: 1.5rem;"></i>
                        <p class="small text-muted mb-0">–£—Ç–µ—á–µ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ!</p>
                    </div>
                `;
            }

        } catch (error) {
            console.error('Failed to load forecast:', error);
            document.getElementById('moneyLeaksList').innerHTML = '<p class="text-center small text-muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</p>';
        }
    }
</script>
{% endblock %}