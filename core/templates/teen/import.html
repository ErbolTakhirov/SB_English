{% extends 'teen/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-header bg-primary bg-gradient text-white p-4">
                    <h2 class="mb-0 h4"><i class="fas fa-magic me-2"></i> Умный Импорт Данных</h2>
                    <p class="mb-0 small opacity-75">Просто вставь текст или загрузи файл — AI разберется.</p>
                </div>
                <div class="card-body p-4">

                    <!-- Alert Area -->
                    <div id="alertArea"></div>

                    <!-- Tabs for Text vs File -->
                    <ul class="nav nav-pills mb-4 nav-justified" id="importTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active rounded-pill" id="text-tab" data-bs-toggle="pill"
                                data-bs-target="#text-content" type="button" role="tab">
                                <i class="fas fa-keyboard me-2"></i>Текст
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link rounded-pill" id="file-tab" data-bs-toggle="pill"
                                data-bs-target="#file-content" type="button" role="tab">
                                <i class="fas fa-file-excel me-2"></i>Файл (CSV/Excel)
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="myTabContent">
                        <!-- Text Import -->
                        <div class="tab-pane fade show active" id="text-content" role="tabpanel">
                            <form id="textImportForm">
                                {% csrf_token %}
                                <div class="mb-4">
                                    <label for="raw_data" class="form-label fw-bold">Вставь данные из СМС или
                                        заметки</label>
                                    <!-- ... (rest of form content) ... -->
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm"
                                            id="textSubmitBtn">
                                            <span class="normal-text"><i class="fas fa-brain me-2"></i>
                                                Распознать</span>
                                            <span class="loading-text d-none"><i
                                                    class="fas fa-spinner fa-spin me-2"></i>
                                                Думаю...</span>
                                        </button>
                                    </div>
                            </form>
                        </div>

                        <!-- File Import -->
                        <div class="tab-pane fade" id="file-content" role="tabpanel">
                            <form id="fileImportForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-4 text-center p-5 border-2 border-dashed rounded-3 bg-light"
                                    id="dropZone">
                                    <!-- ... (rest of file form) ... -->

                                    <script>
                                        document.addEventListener('DOMContentLoaded', function () {
                                            // Robust CSRF Token Retrieval from DOM
                                            function getCsrfToken() {
                                                const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                                                return tokenInput ? tokenInput.value : '';
                                            }

                                            // Text Import Handler
                                            const textForm = document.getElementById('textImportForm');
                                            const textBtn = document.getElementById('textSubmitBtn');

                                            textForm.addEventListener('submit', async function (e) {
                                                e.preventDefault();
                                                const text = document.getElementById('raw_data').value;
                                                const autoCategorize = document.getElementById('autoCategorizeText').checked;
                                                const token = getCsrfToken();

                                                if (!text.trim()) {
                                                    showAlert('Пожалуйста, введите текст', 'warning');
                                                    return;
                                                }

                                                setLoading(textBtn, true);

                                                try {
                                                    const response = await fetch('/api/import/text/', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                            'X-CSRFToken': token
                                                        },
                                                        body: JSON.stringify({
                                                            text: text,
                                                            auto_categorize: autoCategorize
                                                        })
                                                    });

                                                    // Handle non-JSON responses (like 403 HTML page)
                                                    const contentType = response.headers.get("content-type");
                                                    if (!contentType || !contentType.includes("application/json")) {
                                                        throw new Error("Server returned non-JSON response (likely 403 Forbidden or 500 Error)");
                                                    }

                                                    const data = await response.json();

                                                    if (data.success) {
                                                        let msg = `✅ Успешно! Доходы: ${data.incomes_created}, Расходы: ${data.expenses_created}`;
                                                        if (data.review_needed > 0) {
                                                            msg += `. <a href="{% url 'core:review_queue_page' %}" class="alert-link">Требуют проверки: ${data.review_needed}</a>`;
                                                        }
                                                        showAlert(msg, 'success');
                                                        textForm.reset();

                                                        if (data.review_needed > 0) {
                                                            setTimeout(() => {
                                                                window.location.href = "{% url 'core:review_queue_page' %}";
                                                            }, 2000);
                                                        }
                                                    } else {
                                                        showAlert('❌ Ошибка: ' + (data.error || 'Unknown error'), 'danger');
                                                    }
                                                } catch (error) {
                                                    showAlert('❌ Ошибка сети: ' + error.message, 'danger');
                                                    console.error(error);
                                                } finally {
                                                    setLoading(textBtn, false);
                                                }
                                            });

                                            // ... (File input change & Drag-drop listeners remain same) ...

                                            // File Submit
                                            document.getElementById('fileImportForm').addEventListener('submit', async function (e) {
                                                e.preventDefault();
                                                const formData = new FormData(this);
                                                const token = getCsrfToken();

                                                // Append token manually if needed, or rely on header
                                                // formData.append('csrfmiddlewaretoken', token); 

                                                setLoading(fileSubmitBtn, true);

                                                try {
                                                    const response = await fetch('/api/upload/', {
                                                        method: 'POST',
                                                        headers: {
                                                            'X-CSRFToken': token
                                                        },
                                                        body: formData
                                                    });

                                                    const contentType = response.headers.get("content-type");
                                                    if (!contentType || !contentType.includes("application/json")) {
                                                        throw new Error("Server returned non-JSON response");
                                                    }

                                                    const data = await response.json();

                                                    if (data.status === 'success') {
                                                        showAlert('✅ Файл успешно загружен и обработан!', 'success');
                                                        setTimeout(() => window.location.href = "{% url 'core:review_queue_page' %}", 1500);
                                                    } else {
                                                        showAlert('❌ Ошибка: ' + (data.message || 'Unknown error'), 'danger');
                                                    }
                                                } catch (error) {
                                                    showAlert('❌ Ошибка загрузки: ' + error.message, 'danger');
                                                    console.error(error);
                                                } finally {
                                                    setLoading(fileSubmitBtn, false);
                                                }
                                            });

                                            // Helpers
                                            function setLoading(btn, isLoading) {
                                                if (isLoading) {
                                                    btn.disabled = true;
                                                    btn.querySelector('.normal-text').classList.add('d-none');
                                                    btn.querySelector('.loading-text').classList.remove('d-none');
                                                } else {
                                                    btn.disabled = false;
                                                    btn.querySelector('.normal-text').classList.remove('d-none');
                                                    btn.querySelector('.loading-text').classList.add('d-none');
                                                }
                                            }

                                            function showAlert(message, type) {
                                                const alertArea = document.getElementById('alertArea');
                                                alertArea.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
                                            }
                                        });
                                    </script>
                                    {% endblock %}