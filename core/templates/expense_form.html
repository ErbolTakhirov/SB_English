{% extends 'base.html' %}
{% block title %}–†–∞—Å—Ö–æ–¥{% endblock %}

{% block extra_head %}
<style>
/* ============================================================================
   –°–û–í–†–ï–ú–ï–ù–ù–ê–Ø –§–û–†–ú–ê –î–û–•–û–î–ê/–†–ê–°–•–û–î–ê - Card-style, Mobile-first
   ============================================================================ */
:root {
  --form-bg: rgba(255, 255, 255, 0.95);
  --form-border: #e2e8f0;
  --form-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --form-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --primary-color: #10b981;
  --primary-hover: #059669;
  --success-color: #10b981;
  --error-color: #ef4444;
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --radius: 12px;
  --radius-sm: 8px;
}

[data-theme="dark"] {
  --form-bg: rgba(30, 41, 59, 0.95);
  --form-border: #334155;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
}

.form-container {
  max-width: 600px;
  margin: 0 auto;
  padding: 20px;
}

.form-card {
  background: var(--form-bg);
  border-radius: var(--radius);
  box-shadow: var(--form-shadow);
  border: 1px solid var(--form-border);
  padding: 24px;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.form-card:hover {
  box-shadow: var(--form-shadow-hover);
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--form-border);
}

.form-header h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
  color: var(--text-primary);
}

.btn-back {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: transparent;
  border: 1px solid var(--form-border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  transition: all 0.2s;
}

.btn-back:hover {
  background: var(--form-border);
  color: var(--text-primary);
  transform: translateX(-2px);
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 14px;
  color: var(--text-primary);
}

.form-label .required {
  color: var(--error-color);
  margin-left: 2px;
}

.form-control {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--form-border);
  border-radius: var(--radius-sm);
  background: var(--form-bg);
  color: var(--text-primary);
  font-size: 15px;
  transition: all 0.2s;
  font-family: inherit;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.form-control:invalid:not(:placeholder-shown) {
  border-color: var(--error-color);
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 40px;
}

textarea.form-control {
  resize: vertical;
  min-height: 80px;
  line-height: 1.5;
}

.help-text {
  display: block;
  margin-top: 6px;
  font-size: 12px;
  color: var(--text-secondary);
}

.errorlist {
  list-style: none;
  padding: 0;
  margin: 8px 0 0 0;
}

.errorlist li {
  color: var(--error-color);
  font-size: 13px;
  padding: 6px 12px;
  background: rgba(239, 68, 68, 0.1);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--error-color);
  margin-top: 4px;
}

.form-check {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.form-check-input {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.form-check-label {
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--form-border);
}

.btn {
  flex: 1;
  padding: 14px 24px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  text-decoration: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
}

.btn-secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--form-border);
}

.btn-secondary:hover {
  background: var(--form-border);
  color: var(--text-primary);
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  box-shadow: var(--form-shadow);
  z-index: 1000;
  animation: slideIn 0.3s ease;
  max-width: 400px;
}

.notification.success {
  background: var(--success-color);
  color: white;
}

.notification.error {
  background: var(--error-color);
  color: white;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Mobile-first responsive */
@media (max-width: 640px) {
  .form-container {
    padding: 12px;
  }
  
  .form-card {
    padding: 16px;
  }
  
  .form-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
  
  .notification {
    right: 12px;
    left: 12px;
    max-width: none;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <div class="form-card">
    <div class="form-header">
      <h2>üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
      <a href="/expense/" class="btn-back">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
      </a>
    </div>
    
    <form method="post" id="expenseForm" novalidate>
      {% csrf_token %}
      
      {% if form.non_field_errors %}
        <div class="errorlist">
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </div>
      {% endif %}
      
      <div class="form-group">
        <label for="{{ form.amount.id_for_label }}" class="form-label">
          {{ form.amount.label }}
          <span class="required">*</span>
        </label>
        {{ form.amount }}
        {% if form.amount.errors %}
          <ul class="errorlist">
            {% for error in form.amount.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if form.amount.help_text %}
          <span class="help-text">{{ form.amount.help_text }}</span>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label for="{{ form.date.id_for_label }}" class="form-label">
          {{ form.date.label }}
          <span class="required">*</span>
        </label>
        {{ form.date }}
        {% if form.date.errors %}
          <ul class="errorlist">
            {% for error in form.date.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if form.date.help_text %}
          <span class="help-text">{{ form.date.help_text }}</span>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label for="{{ form.category.id_for_label }}" class="form-label">
          {{ form.category.label }}
          <span class="required">*</span>
        </label>
        {{ form.category }}
        <datalist id="expense-categories">
          {% for category in existing_categories %}
            <option value="{{ category }}">{{ category }}</option>
          {% endfor %}
        </datalist>
        {% if form.category.errors %}
          <ul class="errorlist">
            {% for error in form.category.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if form.category.help_text %}
          <span class="help-text">{{ form.category.help_text }}</span>
        {% endif %}
        {% if not existing_categories %}
          <span class="help-text" style="color: var(--text-secondary); font-style: italic;">
            –ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.
          </span>
        {% endif %}
      </div>
      
      <div class="form-group">
        <label for="{{ form.description.id_for_label }}" class="form-label">
          {{ form.description.label }}
        </label>
        {{ form.description }}
        {% if form.description.errors %}
          <ul class="errorlist">
            {% for error in form.description.errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if form.description.help_text %}
          <span class="help-text">{{ form.description.help_text }}</span>
        {% endif %}
      </div>
      
      <div class="form-group">
        <div class="form-check">
          {{ form.auto_categorize }}
          <label for="{{ form.auto_categorize.id_for_label }}" class="form-check-label">
            {{ form.auto_categorize.label }}
          </label>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-check2-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <a href="/expense/" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
      </div>
    </form>
  </div>
</div>

<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
document.addEventListener('DOMContentLoaded', function() {
  const textarea = document.querySelector('textarea.form-control');
  if (textarea) {
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
  }
  
  // –£–ª—É—á—à–µ–Ω–∏–µ UX –¥–ª—è –ø–æ–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å datalist
  const categoryInput = document.querySelector('input[list="expense-categories"]');
  if (categoryInput) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
    categoryInput.addEventListener('focus', function() {
      const datalist = document.getElementById('expense-categories');
      if (datalist && datalist.children.length > 0) {
        this.setAttribute('title', `–î–æ—Å—Ç—É–ø–Ω–æ ${datalist.children.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é.`);
      }
    });
    
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ —Å–ø–∏—Å–∫–∞
    categoryInput.addEventListener('input', function() {
      const value = this.value.trim();
      if (value) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –≤ —Å–ø–∏—Å–∫–µ
        const datalist = document.getElementById('expense-categories');
        if (datalist) {
          const options = Array.from(datalist.children);
          const exactMatch = options.find(opt => opt.value.toLowerCase() === value.toLowerCase());
          if (exactMatch) {
            this.value = exactMatch.value; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
          }
        }
      }
    });
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
  const form = document.getElementById('expenseForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø–æ–ª–µ–π
        const invalidFields = form.querySelectorAll(':invalid');
        invalidFields.forEach(field => {
          field.classList.add('is-invalid');
        });
      }
      
      form.classList.add('was-validated');
    });
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.addEventListener('input', function() {
        if (this.checkValidity()) {
          this.classList.remove('is-invalid');
        }
      });
    });
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –≤ URL
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success') === '1') {
    showNotification('–†–∞—Å—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    form.reset();
  }
});

function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideIn 0.3s ease reverse';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
</script>
{% endblock %}
