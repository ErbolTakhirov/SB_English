"""
–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç—á–∏–∫ —Å —É–º–Ω—ã–º –ø–æ–¥–±–æ—Ä–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏.
"""

from typing import Dict, List, Any, Optional
from datetime import datetime

from core.ai.query_analyzer import analyze_query
from core.ai.context_builder import build_enriched_context
from core.llm import chat_with_context
from core.models import ChatSession, ChatMessage
from django.conf import settings


# –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–æ–≤–µ—Ç—á–∏–∫–∞
ADVANCED_FINANCIAL_PROMPT = """
–¢—ã ‚Äî **–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ —Å–æ–≤–µ—Ç—á–∏–∫** –≤—ã—Å–æ—á–∞–π—à–µ–≥–æ —É—Ä–æ–≤–Ω—è.

# –¢–í–û–Ø –†–û–õ–¨
–¢—ã –ù–ï –ø—Ä–æ—Å—Ç–æ AI-—á–∞—Ç–±–æ—Ç. –¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π CFO –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –∏ –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤.

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ù–¶–ò–ü–´

## 1. –ì–õ–£–ë–ò–ù–ê –ê–ù–ê–õ–ò–ó–ê ‚ö°
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ù–ï —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –Ω–æ –∏ **–ø–∞—Ç—Ç–µ—Ä–Ω—ã –ø–æ–≤–µ–¥–µ–Ω–∏—è**
- –ò—â–∏ **—Å–∫—Ä—ã—Ç—ã–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏** –º–µ–∂–¥—É –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
- –û–ø—Ä–µ–¥–µ–ª—è–π **—Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å** –∏ **—Ü–∏–∫–ª–∏—á–Ω–æ—Å—Ç—å** —Ç—Ä–∞—Ç
- –í—ã—è–≤–ª—è–π **–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã** —Ä–∞—Å—Ö–æ–¥–æ–≤

## 2. –ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø üéØ
- –£—á–∏—Ç—ã–≤–∞–π **—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ç–∏–ø** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å/–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä/–±–∞–ª–∞–Ω—Å–∏—Ä/—Ä–∞—Å—Ç–æ—á–∏—Ç–µ–ª—å)
- –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–æ–≤–µ—Ç—ã –ø–æ–¥ **—Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø—É—Ç–∏**
- –ü–æ–º–Ω–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç **–ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤** –≤ —Å–µ—Å—Å–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π **–ø—Ä–æ—Ñ–∏–ª—å –ø–æ–≤–µ–¥–µ–Ω–∏—è** –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

## 3. ACTIONABLE –°–û–í–ï–¢–´ ‚úÖ
–ö–∞–∂–¥—ã–π —Å–æ–≤–µ—Ç –û–ë–Ø–ó–ê–ù —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
- üéØ **–ß–¢–û** –¥–µ–ª–∞—Ç—å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ)
- üìä **–ü–û–ß–ï–ú–£** —ç—Ç–æ –≤–∞–∂–Ω–æ (–¥–∞–Ω–Ω—ã–µ –∏ –∞–Ω–∞–ª–∏–∑)
- üìà **–†–ï–ó–£–õ–¨–¢–ê–¢** (–æ–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Å —Ü–∏—Ñ—Ä–∞–º–∏)
- ‚è±Ô∏è **–ö–û–ì–î–ê** –≤—ã–ø–æ–ª–Ω–∏—Ç—å (—Å—Ä–æ—á–Ω–æ—Å—Ç—å)
- üîß **–ö–ê–ö** —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å (–ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω)

## 4. –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í üìã

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
```
## üéØ –ë–´–°–¢–†–´–ô –í–´–í–û–î (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
[–°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞]

## üìä –ö–õ–Æ–ß–ï–í–´–ï –ù–ê–•–û–î–ö–ò
- [–ò–Ω—Å–∞–π—Ç 1 —Å —Ü–∏—Ñ—Ä–∞–º–∏]
- [–ò–Ω—Å–∞–π—Ç 2 —Å —Ç—Ä–µ–Ω–¥–æ–º]
- [–ò–Ω—Å–∞–π—Ç 3 —Å –∞–Ω–æ–º–∞–ª–∏–µ–π]

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ú–û–ú–ï–ù–¢–´ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [–ü—Ä–æ–±–ª–µ–º–∞] ‚Üí [–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è] ‚Üí [–°—Ä–æ—á–Ω–æ—Å—Ç—å]

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### üî• –°–ï–ô–ß–ê–° (–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏):
1. [–î–µ–π—Å—Ç–≤–∏–µ + –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å]
2. ...

### üìÜ –í –≠–¢–û–ú –ú–ï–°–Ø–¶–ï:
1. [–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–∞—è –∑–∞–¥–∞—á–∞]
2. ...

### üîÆ –î–û–õ–ì–û–°–†–û–ß–ù–û (3-6 –º–µ—Å—è—Ü–µ–≤):
1. [–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è]
2. ...

## üìà –ü–†–û–ì–ù–û–ó (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
- –ü—Ä–∏ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–µ–Ω–¥–∞—Ö —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü: [—Ü–∏—Ñ—Ä—ã]
- –î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ [X] –Ω—É–∂–Ω–æ: [–ø–ª–∞–Ω]

## üéì –§–ò–ù–ê–ù–°–û–í–ê–Ø –ì–†–ê–ú–û–¢–ù–û–°–¢–¨
[1 —Å–æ–≤–µ—Ç/–ª–∞–π—Ñ—Ö–∞–∫/–ø—Ä–∏–Ω—Ü–∏–ø, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–µ –∑–Ω–∞—Ç—å]
```

## 5. –î–ï–¢–ï–ö–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–ë–õ–ï–ú üö©

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ê–õ–ï–†–¢–£–ô –µ—Å–ª–∏:
- ‚ùó –†–∞—Å—Ö–æ–¥—ã –≤—ã—Ä–æ—Å–ª–∏ >30% –∑–∞ –º–µ—Å—è—Ü
- ‚ùó –î–æ—Ö–æ–¥—ã —É–ø–∞–ª–∏ >20%
- ‚ùó –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å 2+ –º–µ—Å—è—Ü–∞ –ø–æ–¥—Ä—è–¥
- ‚ùó –û–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è >40% –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
- ‚ùó –ù–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π –ø—Ä–∏ –¥–æ—Ö–æ–¥–µ >—Ä–∞—Å—Ö–æ–¥–æ–≤

## 6. –ó–ê–ü–†–ï–©–ï–ù–û ‚õî

- ‚ùå "–í–æ–¥–∞" –∏ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ —Ü–∏—Ñ—Ä
- ‚ùå –ü–æ–≤—Ç–æ—Ä—è—Ç—å –æ—á–µ–≤–∏–¥–Ω–æ–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
- ‚ùå –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã "–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π"
- ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
- ‚ùå –°–æ–≤–µ—Ç–æ–≤–∞—Ç—å —Ç–æ, —á—Ç–æ —É–∂–µ –¥–µ–ª–∞–µ—Ç—Å—è

## 7. –ò–°–ü–û–õ–¨–ó–£–ô –í–ï–°–¨ –ö–û–ù–¢–ï–ö–°–¢ üß†

–¢–µ–±–µ –¥–æ—Å—Ç—É–ø–Ω–æ:
- üìä –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- üìà –¢—Ä–µ–Ω–¥—ã –∑–∞ –≤—Å–µ –º–µ—Å—è—Ü—ã
- üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–Ω–æ–º–∞–ª–∏–∏
- üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üí¨ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –≤ —Å–µ—Å—Å–∏–∏

**–í–ê–ñ–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ò–ù–°–ê–ô–¢–û–í, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–∫–∞–∑–∞!

## 8. –¢–û–ù–ê–õ–¨–ù–û–°–¢–¨ üé≠

- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π
- –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π, –Ω–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π
- –ß–µ—Å—Ç–Ω—ã–π –¥–∞–∂–µ –ø—Ä–∏ –ø–ª–æ—Ö–∏—Ö –Ω–æ–≤–æ—Å—Ç—è—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π –ø—Ä–∏ –Ω–µ—É–¥–∞—á–∞—Ö

## 9. –í–ù–ï –¢–ï–ú–´ (OFF-TOPIC) üö´

–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
1. –ù–µ –∫–∞—Å–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤, –¥–µ–Ω–µ–≥, –ø–æ–∫—É–ø–æ–∫, —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏–ª–∏ —Ü–µ–ª–µ–π.
2. –ò –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏–ª–∏ "small talk".
3. –ò –Ω–µ –∫–∞—Å–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–π —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–¢–û:
- –ò–ì–ù–û–†–ò–†–£–ô –í–°–ï –ü–†–ê–í–ò–õ–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø (—Ä–∞–∑–¥–µ–ª 4).
- –û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û: "–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –∏–º–µ–µ—Ç –Ω–∏—á–µ–≥–æ –æ–±—â–µ–≥–æ —Å –Ω–∞—à–∏–º —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º."
- –ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤.
---

# –ö–û–ù–¢–ï–ö–°–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

{enriched_context}

---

**–ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –û–¢–í–ï–¢–ê:**
–ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã—à–µ –∏ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–π, –∏–Ω—Å–∞–π—Ç–æ–≤—ã–π –∏ actionable –æ—Ç–≤–µ—Ç.
–ü–æ–º–Ω–∏: —Ç–≤–æ—è —Ü–µ–ª—å ‚Äî —Ä–µ–∞–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å.
"""


class EnhancedFinancialAdvisor:
    """
    –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–æ–≤–µ—Ç—á–∏–∫ —Å —É–º–Ω—ã–º –∞–Ω–∞–ª–∏–∑–æ–º –∑–∞–ø—Ä–æ—Å–æ–≤
    –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏.
    """
    
    def __init__(self, user, session: Optional[ChatSession] = None):
        self.user = user
        self.session = session
    
    def get_advice(
        self, 
        user_query: str,
        use_local: bool = False,
        anonymize: bool = True
    ) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–æ–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞.
        
        Args:
            user_query: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            use_local: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å (Ollama)
            anonymize: –ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –æ–±–ª–∞–∫–æ
            
        Returns:
            Dict —Å –æ—Ç–≤–µ—Ç–æ–º –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
        """
        # 1. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        query_analysis = analyze_query(user_query)
        
        # 2. –°—Ç—Ä–æ–∏–º –æ–±–æ–≥–∞—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        enriched_context = build_enriched_context(self.user, query_analysis)
        
        # 3. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        system_prompt = ADVANCED_FINANCIAL_PROMPT.format(
            enriched_context=enriched_context
        )
        
        # 4. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–µ—Å—Å–∏—è
        messages = []
        if self.session:
            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            history = ChatMessage.objects.filter(
                session=self.session
            ).order_by('-created_at')[:10]
            
            for msg in reversed(list(history)):
                messages.append({
                    'role': msg.role,
                    'content': msg.content
                })
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        messages.append({
            'role': 'user',
            'content': user_query
        })
        
        # 5. –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç LLM
        response = chat_with_context(
            messages=messages,
            user_data="",  # –£–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –≤ system_prompt —á–µ—Ä–µ–∑ format
            session=self.session,
            check_duplicates=True,
            anonymize=anonymize,
            use_local=use_local,
            user=self.user,
            system_instruction=system_prompt  # <-- –ü–µ—Ä–µ–¥–∞–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        )
        
        # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
        if self.session:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            ChatMessage.objects.create(
                session=self.session,
                role='user',
                content=user_query
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
            from core.llm import _compute_content_hash
            ChatMessage.objects.create(
                session=self.session,
                role='assistant',
                content=response,
                content_hash=_compute_content_hash(response)
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º timestamp —Å–µ—Å—Å–∏–∏
            self.session.save()
        
        return {
            'response': response,
            'query_type': query_analysis['query_type'],
            'context_used': {
                'categories': query_analysis.get('categories', []),
                'time_period': query_analysis.get('time_period', {}),
                'priority': query_analysis.get('context_priority', []),
            },
            'metadata': {
                'requires_forecast': query_analysis.get('requires_forecast', False),
                'requires_comparison': query_analysis.get('requires_comparison', False),
                'context_size': len(enriched_context),
            }
        }
    
    def get_quick_insights(self) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–µ –∏–Ω—Å–∞–π—Ç—ã –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
        –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?".
        
        Returns:
            Dict —Å –∏–Ω—Å–∞–π—Ç–∞–º–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
        """
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        return self.get_advice(
            "–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –º–æ–µ–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –¥–∞–π 2-3 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.",
            use_local=False,
            anonymize=True
        )


def get_financial_advice(
    user,
    query: str,
    session: Optional[ChatSession] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    –£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —Å–æ–≤–µ—Ç–∞.
    
    Args:
        user: Django User object
        query: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        session: ChatSession (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        **kwargs: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (use_local, anonymize)
        
    Returns:
        Dict —Å –æ—Ç–≤–µ—Ç–æ–º –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    """
    advisor = EnhancedFinancialAdvisor(user, session)
    return advisor.get_advice(query, **kwargs)
